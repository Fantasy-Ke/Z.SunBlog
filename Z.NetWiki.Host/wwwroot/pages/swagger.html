<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Swagger</title>
    <link rel="stylesheet" type="text/css" href="./swagger-ui.css">
</head>
<body>
    <div id="swagger-ui"></div>
</body>
</html>

<script src="swagger-ui-bundle.js"></script>
<script src="swagger-ui-standalone-preset.js"></script>
<script>
    window.onload = function () {
        var configObject = JSON.parse('%(ConfigObject)');
        const cookieValue = getCookiesValue('x-access-token');
        const token = getCookiesValue('Z.BearerCokkie');
        const isExpired = isCookieExpired(token);

        if (isExpired) {
            window.location.href = '/home/index';
        }

        // Apply mandatory parameters
        configObject.dom_id = "#swagger-ui";
        configObject.presets = [SwaggerUIBundle.presets.apis, SwaggerUIStandalonePreset];
        configObject.layout = "StandaloneLayout";
        configObject.requestInterceptor = function (request) {


            request.headers['Authorization'] = 'Bearer ' + cookieValue;
            return request;
        };

        if (!configObject.hasOwnProperty("oauth2RedirectUrl")) {
            configObject.oauth2RedirectUrl = window.location + "oauth2-redirect.html"; // use the built-in default
        }

        configObject.plugins = [
            function (system) {
                return {
                    components: {
                        authorizeBtn: function () {
                            return null;
                        }
                    }
                }
            }
        ];

        // Build a system
        SwaggerUIBundle(configObject);
    }


    // 检查Cookie是否过期
    const isCookieExpired = function (cookieValue) {
        
        if (cookieValue) {
            const cookieExpires = new Date(cookieValue);
            const currentTime = new Date();

            // 比较当前时间与Cookie的过期时间
            return currentTime > cookieExpires;
        }

        return true; // Cookie不存在或无效，视为过期
    }


    const getCookiesValue = function (key) {
        var equalities = document.cookie.split('; ');
        for (var i = 0; i < equalities.length; i++) {
            if (!equalities[i]) {
                continue;
            }

            var splitted = equalities[i].split('=');
            if (splitted.length != 2) {
                continue;
            }

            if (decodeURIComponent(splitted[0]) === key) {
                return decodeURIComponent(splitted[1] || '');
            }
        }

        return null;
    };

</script>
